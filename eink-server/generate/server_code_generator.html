<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.7.5" />
<title>eink.generate.server_code_generator API documentation</title>
<meta name="description" content="" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>eink.generate.server_code_generator</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import functools
import getpass
import json
import os
import re
import shutil
import socket
import string
import subprocess
import sys
from urllib.parse import urlparse

from .client_code_generator import ClientCodeGenerator
from .client_config import ClientConfig
from ..project.project import Project
from .rotation import Rotation
from .status_images import StatusImages
from .web_transport import WebTransport


class ServerCodeGenerator:
    &#34;&#34;&#34;Generates skeleton code for an e-ink server.&#34;&#34;&#34;

    @staticmethod
    def gen_skeleton():
        &#34;&#34;&#34;Generate skeleton code for an e-ink server.

        We request information about the server using standard input and
        output.
        &#34;&#34;&#34;
        ServerCodeGenerator._gen_skeleton(
            *ServerCodeGenerator._input_skeleton_params())

    @staticmethod
    def _input(prompt, default, validation_func, hidden=False):
        &#34;&#34;&#34;Prompt the user for a string input.

        The basic procedure is something like this:

        * Display the prompt.
        * If nothing is entered, return the default value.
        * Otherwise, validate the value using validation_func.
        * If valid, return the value entered.
        * If invalid, print an error message and repeat.

        However, the ``_input`` method is responsible for the details.

        Arguments:
            prompt (str): Text to present to the user indicating what
                information to enter.
            default (str): The value to return if the user enters the
                empty string. If this is ``None``, then we return
                ``&#39;&#39;``.
            validation_func (callable): A function for validating the
                result. If it raises a ``RuntimeError`` when we pass in
                the value the user entered, then that value is not
                permitted. Such errors should have messages that are
                suitable to display to the user.
            hidden (bool): Whether to hide the user&#39;s input as he enters
                it. This is useful for passwords.

        Returns:
            str: The value the user entered, or the default value.
        &#34;&#34;&#34;
        if default is None:
            default = &#39;&#39;
        if prompt.endswith(&#39;\n&#39;):
            prompt_with_default = &#39;{:s}[{:s}] &#39;.format(prompt, default)
        else:
            prompt_with_default = &#39;{:s} [{:s}] &#39;.format(prompt, default)

        while True:
            if hidden:
                value = getpass.getpass(prompt_with_default)
            else:
                value = input(prompt_with_default)

            if value == &#39;&#39;:
                return default
            elif validation_func is None:
                return value

            try:
                validation_func(value)
            except RuntimeError as error:
                print()
                print(error.message)
                print()
            else:
                return value

    @staticmethod
    def _normalize_filename(filename):
        &#34;&#34;&#34;Equivalent implementation is contractually guaranteed.&#34;&#34;&#34;
        return os.path.abspath(os.path.expanduser(filename))

    @staticmethod
    def _validate_server_dir(dir_):
        &#34;&#34;&#34;Validate the server directory.

        Raise a ``RuntimeError`` if the specified user entry is not a
        valid server directory.

        Arguments:
            dir_ (str): The user entry.
        &#34;&#34;&#34;
        try:
            absolute_dir = ServerCodeGenerator._normalize_filename(dir_)
        except OSError:
            raise RuntimeError(
                &#39;Error normalizing the filename {:s}&#39;.format(dir_))

        parent = os.path.dirname(absolute_dir)
        if not os.path.isdir(parent):
            raise ValueError(
                &#39;The parent folder {:s} does not exist&#39;.format(parent))

    @staticmethod
    def _validate_client_dir(server_dir, dir_):
        &#34;&#34;&#34;Validate the client directory.

        Raise a ``RuntimeError`` if the specified user entry is not a
        valid client directory.

        Arguments:
            server_dir (str): The server directory.
            dir_ (str): The user entry.
        &#34;&#34;&#34;
        try:
            absolute_dir = ServerCodeGenerator._normalize_filename(dir_)
        except OSError:
            raise RuntimeError(
                &#39;Error normalizing the filename {:s}&#39;.format(dir_))

        try:
            if (absolute_dir ==
                    ServerCodeGenerator._normalize_filename(server_dir)):
                raise ValueError(
                    &#39;The client code directory may not be the same as the &#39;
                    &#39;server code directory&#39;)
        except OSError:
            pass

        parent = os.path.dirname(absolute_dir)
        try:
            if parent == ServerCodeGenerator._normalize_filename(server_dir):
                return
        except OSError:
            pass

        if not os.path.isdir(parent):
            raise ValueError(
                &#39;The parent folder {:s} does not exist&#39;.format(parent))

    @staticmethod
    def _validate_url(url):
        &#34;&#34;&#34;Validate the server URL.

        Raise a ``ValueError`` if the specified user entry is not a
        valid server URL.

        Arguments:
            url (str): The user entry.
        &#34;&#34;&#34;
        scheme = urlparse(url).scheme
        if scheme == &#39;https&#39;:
            raise ValueError(
                &#39;The URL must begin with http://. HTTPS is currently not &#39;
                &#39;supported.&#39;)
        elif scheme != &#39;http&#39;:
            raise ValueError(&#39;The URL must begin with http://&#39;)

    @staticmethod
    def _validate_non_empty(value):
        &#34;&#34;&#34;Validate an input that may not be empty.

        Raise a ``ValueError`` if the specified user entry is the empty
        string.

        Arguments:
            value (str): The user entry.
        &#34;&#34;&#34;
        if not value:
            raise ValueError(&#39;Please enter a value&#39;)

    @staticmethod
    def _validate_rotation(rotation_str):
        &#34;&#34;&#34;Validate the rotation.

        Raise a ``ValueError`` if the specified user entry is not a
        valid device rotation.

        Arguments:
            rotation_str (str): The user entry.
        &#34;&#34;&#34;
        if rotation_str not in [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;]:
            raise ValueError(&#39;The rotation must be 1 - 4&#39;)

    @staticmethod
    def _validate_positive_int(value):
        &#34;&#34;&#34;Validate a positive integer.

        Raise a ``ValueError`` if the specified user entry is not a
        positive integer.

        Arguments:
            value (str): The user entry.
        &#34;&#34;&#34;
        if not re.search(r&#39;^[1-9]\d*$&#39;, value):
            raise ValueError(&#39;Please enter a positive integer&#39;)

    @staticmethod
    def _local_ip_address():
        &#34;&#34;&#34;Return the device&#39;s local IP address, e.g. ``&#39;192.168.1.70&#39;``.&#34;&#34;&#34;
        # Based on https://stackoverflow.com/a/28950776/10935386
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        try:
            # Doesn&#39;t even have to be reachable
            s.connect((&#39;10.255.255.255&#39;, 1))
            return s.getsockname()[0]
        except InterruptedError:
            return &#39;127.0.0.1&#39;
        finally:
            s.close()

    @staticmethod
    def _ssid():
        &#34;&#34;&#34;Return the SSID for the Wi-Fi network we are connected to, if any.

        Return ``None`` if we were unable to determine the SSID.
        &#34;&#34;&#34;
        if os.name == &#39;nt&#39; or sys.platform == &#39;darwin&#39;:
            if os.name == &#39;nt&#39;:
                command = [&#39;Netsh&#39;, &#39;WLAN&#39;, &#39;show&#39;, &#39;interfaces&#39;]
            else:
                command = [
                    &#39;/System/Library/PrivateFrameworks/Apple80211.framework/&#39;
                    &#39;Resources/airport&#39;,
                    &#39;-I&#39;]

            try:
                output = subprocess.check_output(command).decode()
            except (
                    OSError, subprocess.CalledProcessError,
                    UnicodeDecodeError):
                return None
            for line in output.split(&#39;\n&#39;):
                stripped_line = line.strip()
                if stripped_line.startswith(&#39;SSID&#39;):
                    index = stripped_line.index(&#39;:&#39;)
                    return stripped_line[index + 2:]
            return None
        else:
            try:
                output = subprocess.check_output([
                    &#39;/sbin/iwgetid&#39;, &#39;-r&#39;]).decode()
            except (
                    OSError, subprocess.CalledProcessError,
                    UnicodeDecodeError):
                return None
            ssid = output.rstrip(&#39;\n&#39;)
            if ssid:
                return ssid
            else:
                return None

    @staticmethod
    def _input_skeleton_params():
        &#34;&#34;&#34;Prompt the user for all of the parameters to ``_gen_skeleton``.

        The return value is a tuple with all of those parameters, in
        order.
        &#34;&#34;&#34;
        local_ip_address = ServerCodeGenerator._local_ip_address()
        connected_ssid = ServerCodeGenerator._ssid()
        if os.name == &#39;nt&#39;:
            default_server_dir = os.path.join(
                os.path.expanduser(&#39;~&#39;), &#39;Documents&#39;, &#39;eink_server&#39;)
        else:
            default_server_dir = os.path.join(&#39;~&#39;, &#39;eink_server&#39;)

        server_dir = ServerCodeGenerator._input(
            &#39;Directory for the server code&#39;, default_server_dir,
            ServerCodeGenerator._validate_server_dir)
        client_dir = ServerCodeGenerator._input(
            &#39;Directory for the client code&#39;,
            os.path.join(server_dir, &#39;client&#39;),
            functools.partial(
                ServerCodeGenerator._validate_client_dir, server_dir))
        url = ServerCodeGenerator._input(
            &#39;Server URL&#39;,
            &#39;http://{:s}:5000/eink_server&#39;.format(local_ip_address),
            ServerCodeGenerator._validate_url)
        ssid = ServerCodeGenerator._input(
            &#39;Wi-Fi SSID for device to connect to&#39;, connected_ssid,
            ServerCodeGenerator._validate_non_empty)
        wi_fi_password = ServerCodeGenerator._input(
            &#39;Password for Wi-Fi (leave blank if none)&#39;, None, None, True)

        rotation_str = ServerCodeGenerator._input(
            &#39;Device rotation:\n&#39;
            &#39;1) Portrait right (bottom of device on right)\n&#39;
            &#39;2) Landscape upside down\n&#39;
            &#39;3) Portrait left (bottom of device on left)\n&#39;
            &#39;4) Landscape\n&#39;,
            &#39;4&#39;, ServerCodeGenerator._validate_rotation)

        default_width = &#39;800&#39;
        default_height = &#39;600&#39;
        if (rotation_str == str(Rotation.LANDSCAPE.value) or
                rotation_str == str(Rotation.LANDSCAPE_UPSIDE_DOWN.value)):
            width_prompt = &#39;Device width in pixels&#39;
            height_prompt = &#39;Device height in pixels&#39;
        else:
            width_prompt = &#39;Device width in pixels, after rotation&#39;
            height_prompt = &#39;Device height in pixels, after rotation&#39;
            default_width, default_height = default_height, default_width
        width = ServerCodeGenerator._input(
            width_prompt, default_width,
            ServerCodeGenerator._validate_positive_int)
        height = ServerCodeGenerator._input(
            height_prompt, default_height,
            ServerCodeGenerator._validate_positive_int)
        return (
            server_dir, client_dir, url, ssid, wi_fi_password, rotation_str,
            width, height)

    @staticmethod
    def _eval_template(server_dir, filename, params):
        &#34;&#34;&#34;Evaluate a source code template.

        This reads the template at
        assets/server_skeleton/[filename].tpl, performs string
        substitutions using ``string.Template.substitute(params)``, and
        stores the result in [server_dir]/[filename].

        Arguments:
            server_dir (str): The directory in which to store the
                resulting file.
            filename (str): The filename of the resulting file,
                excluding the directory.
            params (dict&lt;str, str&gt;): The parameters to the template.
        &#34;&#34;&#34;
        input_filename = os.path.join(
            Project.server_skeleton_dir(), &#39;{:s}.tpl&#39;.format(filename))
        with open(input_filename, &#39;r&#39;) as file:
            template = file.read()

        contents = string.Template(template).substitute(params)
        output_filename = os.path.join(server_dir, filename)
        with open(output_filename, &#39;w&#39;) as file:
            file.write(contents)

    @staticmethod
    def _write_gen_client_code(
            server_dir, client_dir, url, ssid, wi_fi_password, rotation):
        &#34;&#34;&#34;Write the contents of the gen_client_code.py file.

        This contains code for generating the client&#39;s source code.

        Arguments:
            server_dir (str): The directory in which to store the
                resulting file.
            client_dir (str): The directory in which the client code is
                stored.
            url (str): The server&#39;s URL.
            ssid (str): The SSID of the Wi-Fi network that the client
                should connect to.
            wi_fi_password (str): The password of the Wi-Fi network that
                the client should connect to. If this is ``&#39;&#39;``, then
                there is no password.
            rotation (Rotation): The rotation to use when drawing to the
                Inkplate device.
        &#34;&#34;&#34;
        import_os = &#39;&#39;
        import_separator = &#39;&#39;
        if not wi_fi_password:
            wi_fi_password_code = &#39;None&#39;
            import_json = &#39;&#39;
            read_secrets = &#39;&#39;
        else:
            wi_fi_password_code = &#34;_read_secrets()[&#39;wiFiPassword&#39;]&#34;
            import_json = &#39;\nimport json&#39;
            import_os = &#39;\nimport os&#39;
            import_separator = &#39;\n&#39;
            read_secrets = (
                &#39;\ndef _read_secrets():\n&#39;
                &#39;    &#34;&#34;&#34;Return the JSON value stored in &#39;
                &#39;assets/secrets.json.&#34;&#34;&#34;\n&#39;
                &#39;    project_dir = &#39;
                &#39;os.path.dirname(os.path.abspath(__file__))\n&#39;
                &#39;    secrets_filename = &#39;
                &#34;os.path.join(project_dir, &#39;assets&#39;, &#39;secrets.json&#39;)\n&#34;
                &#34;    with open(secrets_filename, &#39;r&#39;) as file:\n&#34;
                &#39;        return json.load(file)\n\n&#39;)

        if rotation == Rotation.LANDSCAPE:
            set_rotation = &#39;&#39;
            import_rotation = &#39;&#39;
        else:
            set_rotation = &#39;\n    config.set_rotation(Rotation.{:s})&#39;.format(
                rotation.name)
            import_rotation = &#39;from eink.generate import Rotation\n&#39;

        if os.path.dirname(client_dir) != server_dir:
            set_client_dir = &#39;    dir_ = {:s}&#39;.format(repr(client_dir))
        else:
            set_client_dir = (
                &#39;    project_dir = &#39;
                &#39;os.path.dirname(os.path.abspath(__file__))\n&#39;
                &#39;    dir_ = os.path.join(project_dir, {:s})&#39;.format(
                    repr(os.path.basename(client_dir))))
            import_os = &#39;\nimport os&#39;
            import_separator = &#39;\n&#39;

        ServerCodeGenerator._eval_template(
            server_dir, &#39;gen_client_code.py&#39;, {
                &#39;import_json&#39;: import_json,
                &#39;import_os&#39;: import_os,
                &#39;import_rotation&#39;: import_rotation,
                &#39;import_separator&#39;: import_separator,
                &#39;read_secrets&#39;: read_secrets,
                &#39;set_client_dir&#39;: set_client_dir,
                &#39;set_rotation&#39;: set_rotation,
                &#39;ssid&#39;: repr(ssid),
                &#39;url&#39;: repr(url),
                &#39;wi_fi_password&#39;: wi_fi_password_code,
            })

    @staticmethod
    def _gen_client_code(
            client_dir, url, ssid, wi_fi_password, rotation, width, height):
        &#34;&#34;&#34;Generate the client code for the skeleton.

        Arguments:
            client_dir (str): The directory in which to store the client
                code.
            url (str): The server&#39;s URL.
            ssid (str): The SSID of the Wi-Fi network that the client
                should connect to.
            wi_fi_password (str): The password of the Wi-Fi network that
                the client should connect to. If this is ``&#39;&#39;``, then
                there is no password.
            rotation (Rotation): The rotation to use when drawing to the
                Inkplate device.
            width (str): The width of the Inkplate device, as a string,
                after applying the rotation suggested by ``rotation``.
            height (str): The height of the Inkplate device, as a
                string, after applying the rotation suggested by
                ``rotation``.
        &#34;&#34;&#34;
        status_images = StatusImages.create_default(int(width), int(height))
        config = ClientConfig(WebTransport(url), status_images)
        if wi_fi_password:
            config.add_wi_fi_network(ssid, wi_fi_password)
        else:
            config.add_wi_fi_network(ssid, None)
        config.set_rotation(rotation)
        ClientCodeGenerator.gen(config, client_dir)

    @staticmethod
    def _gen_skeleton(
            server_dir, client_dir, url, ssid, wi_fi_password, rotation_str,
            width, height):
        &#34;&#34;&#34;Generate a skeleton server.

        Arguments:
            server_dir (str): The directory in which to store the
                server.
            client_dir (str): The directory in which to store the client
                code.
            url (str): The server&#39;s URL.
            ssid (str): The SSID of the Wi-Fi network that the client
                should connect to.
            wi_fi_password (str): The password of the Wi-Fi network that
                the client should connect to. If this is ``&#39;&#39;``, then
                there is no password.
            rotation_str (str): The rotation to use when drawing to the
                Inkplate device. This is the string representation of
                the value of the relevant ``Rotation``.
            width (str): The width of the Inkplate device, as a string,
                after applying the rotation suggested by
                ``rotation_str``.
            height (str): The height of the Inkplate device, as a
                string, after applying the rotation suggested by
                ``rotation_str``.
        &#34;&#34;&#34;
        server_dir = ServerCodeGenerator._normalize_filename(server_dir)
        assets_dir = os.path.join(server_dir, &#39;assets&#39;)
        client_dir = ServerCodeGenerator._normalize_filename(client_dir)
        if not os.path.exists(server_dir):
            os.mkdir(server_dir)
        if not os.path.exists(assets_dir):
            os.mkdir(assets_dir)
        if not os.path.exists(client_dir):
            os.mkdir(client_dir)

        ServerCodeGenerator._eval_template(
            server_dir, &#39;my_server.py&#39;, {
                &#39;height&#39;: height,
                &#39;width&#39;: width,
            })

        parsed_url = urlparse(url)
        if parsed_url.path:
            path = parsed_url.path
        else:
            path = &#39;/&#39;
        ServerCodeGenerator._eval_template(
            server_dir, &#39;app.py&#39;, {&#39;path&#39;: repr(path)})

        shutil.copy(
            os.path.join(Project.server_skeleton_dir(), &#39;requirements.txt&#39;),
            os.path.join(server_dir, &#39;requirements.txt&#39;))
        shutil.copy(
            os.path.join(Project.server_skeleton_dir(), &#39;GentiumPlus-R.ttf&#39;),
            os.path.join(assets_dir, &#39;GentiumPlus-R.ttf&#39;))
        shutil.copy(
            os.path.join(Project.server_skeleton_dir(), &#39;OFL.txt&#39;),
            os.path.join(assets_dir, &#39;OFL.txt&#39;))

        if wi_fi_password:
            secrets = {&#39;wiFiPassword&#39;: wi_fi_password}
            with open(os.path.join(assets_dir, &#39;secrets.json&#39;), &#39;w&#39;) as file:
                file.write(json.dumps(secrets, indent=4))
                file.write(&#39;\n&#39;)

        rotation = Rotation(int(rotation_str))
        ServerCodeGenerator._write_gen_client_code(
            server_dir, client_dir, url, ssid, wi_fi_password, rotation)
        ServerCodeGenerator._gen_client_code(
            client_dir, url, ssid, wi_fi_password, rotation, width, height)


if __name__ == &#39;__main__&#39;:
    ServerCodeGenerator.gen_skeleton()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="eink.generate.server_code_generator.ServerCodeGenerator"><code class="flex name class">
<span>class <span class="ident">ServerCodeGenerator</span></span>
</code></dt>
<dd>
<section class="desc"><p>Generates skeleton code for an e-ink server.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ServerCodeGenerator:
    &#34;&#34;&#34;Generates skeleton code for an e-ink server.&#34;&#34;&#34;

    @staticmethod
    def gen_skeleton():
        &#34;&#34;&#34;Generate skeleton code for an e-ink server.

        We request information about the server using standard input and
        output.
        &#34;&#34;&#34;
        ServerCodeGenerator._gen_skeleton(
            *ServerCodeGenerator._input_skeleton_params())

    @staticmethod
    def _input(prompt, default, validation_func, hidden=False):
        &#34;&#34;&#34;Prompt the user for a string input.

        The basic procedure is something like this:

        * Display the prompt.
        * If nothing is entered, return the default value.
        * Otherwise, validate the value using validation_func.
        * If valid, return the value entered.
        * If invalid, print an error message and repeat.

        However, the ``_input`` method is responsible for the details.

        Arguments:
            prompt (str): Text to present to the user indicating what
                information to enter.
            default (str): The value to return if the user enters the
                empty string. If this is ``None``, then we return
                ``&#39;&#39;``.
            validation_func (callable): A function for validating the
                result. If it raises a ``RuntimeError`` when we pass in
                the value the user entered, then that value is not
                permitted. Such errors should have messages that are
                suitable to display to the user.
            hidden (bool): Whether to hide the user&#39;s input as he enters
                it. This is useful for passwords.

        Returns:
            str: The value the user entered, or the default value.
        &#34;&#34;&#34;
        if default is None:
            default = &#39;&#39;
        if prompt.endswith(&#39;\n&#39;):
            prompt_with_default = &#39;{:s}[{:s}] &#39;.format(prompt, default)
        else:
            prompt_with_default = &#39;{:s} [{:s}] &#39;.format(prompt, default)

        while True:
            if hidden:
                value = getpass.getpass(prompt_with_default)
            else:
                value = input(prompt_with_default)

            if value == &#39;&#39;:
                return default
            elif validation_func is None:
                return value

            try:
                validation_func(value)
            except RuntimeError as error:
                print()
                print(error.message)
                print()
            else:
                return value

    @staticmethod
    def _normalize_filename(filename):
        &#34;&#34;&#34;Equivalent implementation is contractually guaranteed.&#34;&#34;&#34;
        return os.path.abspath(os.path.expanduser(filename))

    @staticmethod
    def _validate_server_dir(dir_):
        &#34;&#34;&#34;Validate the server directory.

        Raise a ``RuntimeError`` if the specified user entry is not a
        valid server directory.

        Arguments:
            dir_ (str): The user entry.
        &#34;&#34;&#34;
        try:
            absolute_dir = ServerCodeGenerator._normalize_filename(dir_)
        except OSError:
            raise RuntimeError(
                &#39;Error normalizing the filename {:s}&#39;.format(dir_))

        parent = os.path.dirname(absolute_dir)
        if not os.path.isdir(parent):
            raise ValueError(
                &#39;The parent folder {:s} does not exist&#39;.format(parent))

    @staticmethod
    def _validate_client_dir(server_dir, dir_):
        &#34;&#34;&#34;Validate the client directory.

        Raise a ``RuntimeError`` if the specified user entry is not a
        valid client directory.

        Arguments:
            server_dir (str): The server directory.
            dir_ (str): The user entry.
        &#34;&#34;&#34;
        try:
            absolute_dir = ServerCodeGenerator._normalize_filename(dir_)
        except OSError:
            raise RuntimeError(
                &#39;Error normalizing the filename {:s}&#39;.format(dir_))

        try:
            if (absolute_dir ==
                    ServerCodeGenerator._normalize_filename(server_dir)):
                raise ValueError(
                    &#39;The client code directory may not be the same as the &#39;
                    &#39;server code directory&#39;)
        except OSError:
            pass

        parent = os.path.dirname(absolute_dir)
        try:
            if parent == ServerCodeGenerator._normalize_filename(server_dir):
                return
        except OSError:
            pass

        if not os.path.isdir(parent):
            raise ValueError(
                &#39;The parent folder {:s} does not exist&#39;.format(parent))

    @staticmethod
    def _validate_url(url):
        &#34;&#34;&#34;Validate the server URL.

        Raise a ``ValueError`` if the specified user entry is not a
        valid server URL.

        Arguments:
            url (str): The user entry.
        &#34;&#34;&#34;
        scheme = urlparse(url).scheme
        if scheme == &#39;https&#39;:
            raise ValueError(
                &#39;The URL must begin with http://. HTTPS is currently not &#39;
                &#39;supported.&#39;)
        elif scheme != &#39;http&#39;:
            raise ValueError(&#39;The URL must begin with http://&#39;)

    @staticmethod
    def _validate_non_empty(value):
        &#34;&#34;&#34;Validate an input that may not be empty.

        Raise a ``ValueError`` if the specified user entry is the empty
        string.

        Arguments:
            value (str): The user entry.
        &#34;&#34;&#34;
        if not value:
            raise ValueError(&#39;Please enter a value&#39;)

    @staticmethod
    def _validate_rotation(rotation_str):
        &#34;&#34;&#34;Validate the rotation.

        Raise a ``ValueError`` if the specified user entry is not a
        valid device rotation.

        Arguments:
            rotation_str (str): The user entry.
        &#34;&#34;&#34;
        if rotation_str not in [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;]:
            raise ValueError(&#39;The rotation must be 1 - 4&#39;)

    @staticmethod
    def _validate_positive_int(value):
        &#34;&#34;&#34;Validate a positive integer.

        Raise a ``ValueError`` if the specified user entry is not a
        positive integer.

        Arguments:
            value (str): The user entry.
        &#34;&#34;&#34;
        if not re.search(r&#39;^[1-9]\d*$&#39;, value):
            raise ValueError(&#39;Please enter a positive integer&#39;)

    @staticmethod
    def _local_ip_address():
        &#34;&#34;&#34;Return the device&#39;s local IP address, e.g. ``&#39;192.168.1.70&#39;``.&#34;&#34;&#34;
        # Based on https://stackoverflow.com/a/28950776/10935386
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        try:
            # Doesn&#39;t even have to be reachable
            s.connect((&#39;10.255.255.255&#39;, 1))
            return s.getsockname()[0]
        except InterruptedError:
            return &#39;127.0.0.1&#39;
        finally:
            s.close()

    @staticmethod
    def _ssid():
        &#34;&#34;&#34;Return the SSID for the Wi-Fi network we are connected to, if any.

        Return ``None`` if we were unable to determine the SSID.
        &#34;&#34;&#34;
        if os.name == &#39;nt&#39; or sys.platform == &#39;darwin&#39;:
            if os.name == &#39;nt&#39;:
                command = [&#39;Netsh&#39;, &#39;WLAN&#39;, &#39;show&#39;, &#39;interfaces&#39;]
            else:
                command = [
                    &#39;/System/Library/PrivateFrameworks/Apple80211.framework/&#39;
                    &#39;Resources/airport&#39;,
                    &#39;-I&#39;]

            try:
                output = subprocess.check_output(command).decode()
            except (
                    OSError, subprocess.CalledProcessError,
                    UnicodeDecodeError):
                return None
            for line in output.split(&#39;\n&#39;):
                stripped_line = line.strip()
                if stripped_line.startswith(&#39;SSID&#39;):
                    index = stripped_line.index(&#39;:&#39;)
                    return stripped_line[index + 2:]
            return None
        else:
            try:
                output = subprocess.check_output([
                    &#39;/sbin/iwgetid&#39;, &#39;-r&#39;]).decode()
            except (
                    OSError, subprocess.CalledProcessError,
                    UnicodeDecodeError):
                return None
            ssid = output.rstrip(&#39;\n&#39;)
            if ssid:
                return ssid
            else:
                return None

    @staticmethod
    def _input_skeleton_params():
        &#34;&#34;&#34;Prompt the user for all of the parameters to ``_gen_skeleton``.

        The return value is a tuple with all of those parameters, in
        order.
        &#34;&#34;&#34;
        local_ip_address = ServerCodeGenerator._local_ip_address()
        connected_ssid = ServerCodeGenerator._ssid()
        if os.name == &#39;nt&#39;:
            default_server_dir = os.path.join(
                os.path.expanduser(&#39;~&#39;), &#39;Documents&#39;, &#39;eink_server&#39;)
        else:
            default_server_dir = os.path.join(&#39;~&#39;, &#39;eink_server&#39;)

        server_dir = ServerCodeGenerator._input(
            &#39;Directory for the server code&#39;, default_server_dir,
            ServerCodeGenerator._validate_server_dir)
        client_dir = ServerCodeGenerator._input(
            &#39;Directory for the client code&#39;,
            os.path.join(server_dir, &#39;client&#39;),
            functools.partial(
                ServerCodeGenerator._validate_client_dir, server_dir))
        url = ServerCodeGenerator._input(
            &#39;Server URL&#39;,
            &#39;http://{:s}:5000/eink_server&#39;.format(local_ip_address),
            ServerCodeGenerator._validate_url)
        ssid = ServerCodeGenerator._input(
            &#39;Wi-Fi SSID for device to connect to&#39;, connected_ssid,
            ServerCodeGenerator._validate_non_empty)
        wi_fi_password = ServerCodeGenerator._input(
            &#39;Password for Wi-Fi (leave blank if none)&#39;, None, None, True)

        rotation_str = ServerCodeGenerator._input(
            &#39;Device rotation:\n&#39;
            &#39;1) Portrait right (bottom of device on right)\n&#39;
            &#39;2) Landscape upside down\n&#39;
            &#39;3) Portrait left (bottom of device on left)\n&#39;
            &#39;4) Landscape\n&#39;,
            &#39;4&#39;, ServerCodeGenerator._validate_rotation)

        default_width = &#39;800&#39;
        default_height = &#39;600&#39;
        if (rotation_str == str(Rotation.LANDSCAPE.value) or
                rotation_str == str(Rotation.LANDSCAPE_UPSIDE_DOWN.value)):
            width_prompt = &#39;Device width in pixels&#39;
            height_prompt = &#39;Device height in pixels&#39;
        else:
            width_prompt = &#39;Device width in pixels, after rotation&#39;
            height_prompt = &#39;Device height in pixels, after rotation&#39;
            default_width, default_height = default_height, default_width
        width = ServerCodeGenerator._input(
            width_prompt, default_width,
            ServerCodeGenerator._validate_positive_int)
        height = ServerCodeGenerator._input(
            height_prompt, default_height,
            ServerCodeGenerator._validate_positive_int)
        return (
            server_dir, client_dir, url, ssid, wi_fi_password, rotation_str,
            width, height)

    @staticmethod
    def _eval_template(server_dir, filename, params):
        &#34;&#34;&#34;Evaluate a source code template.

        This reads the template at
        assets/server_skeleton/[filename].tpl, performs string
        substitutions using ``string.Template.substitute(params)``, and
        stores the result in [server_dir]/[filename].

        Arguments:
            server_dir (str): The directory in which to store the
                resulting file.
            filename (str): The filename of the resulting file,
                excluding the directory.
            params (dict&lt;str, str&gt;): The parameters to the template.
        &#34;&#34;&#34;
        input_filename = os.path.join(
            Project.server_skeleton_dir(), &#39;{:s}.tpl&#39;.format(filename))
        with open(input_filename, &#39;r&#39;) as file:
            template = file.read()

        contents = string.Template(template).substitute(params)
        output_filename = os.path.join(server_dir, filename)
        with open(output_filename, &#39;w&#39;) as file:
            file.write(contents)

    @staticmethod
    def _write_gen_client_code(
            server_dir, client_dir, url, ssid, wi_fi_password, rotation):
        &#34;&#34;&#34;Write the contents of the gen_client_code.py file.

        This contains code for generating the client&#39;s source code.

        Arguments:
            server_dir (str): The directory in which to store the
                resulting file.
            client_dir (str): The directory in which the client code is
                stored.
            url (str): The server&#39;s URL.
            ssid (str): The SSID of the Wi-Fi network that the client
                should connect to.
            wi_fi_password (str): The password of the Wi-Fi network that
                the client should connect to. If this is ``&#39;&#39;``, then
                there is no password.
            rotation (Rotation): The rotation to use when drawing to the
                Inkplate device.
        &#34;&#34;&#34;
        import_os = &#39;&#39;
        import_separator = &#39;&#39;
        if not wi_fi_password:
            wi_fi_password_code = &#39;None&#39;
            import_json = &#39;&#39;
            read_secrets = &#39;&#39;
        else:
            wi_fi_password_code = &#34;_read_secrets()[&#39;wiFiPassword&#39;]&#34;
            import_json = &#39;\nimport json&#39;
            import_os = &#39;\nimport os&#39;
            import_separator = &#39;\n&#39;
            read_secrets = (
                &#39;\ndef _read_secrets():\n&#39;
                &#39;    &#34;&#34;&#34;Return the JSON value stored in &#39;
                &#39;assets/secrets.json.&#34;&#34;&#34;\n&#39;
                &#39;    project_dir = &#39;
                &#39;os.path.dirname(os.path.abspath(__file__))\n&#39;
                &#39;    secrets_filename = &#39;
                &#34;os.path.join(project_dir, &#39;assets&#39;, &#39;secrets.json&#39;)\n&#34;
                &#34;    with open(secrets_filename, &#39;r&#39;) as file:\n&#34;
                &#39;        return json.load(file)\n\n&#39;)

        if rotation == Rotation.LANDSCAPE:
            set_rotation = &#39;&#39;
            import_rotation = &#39;&#39;
        else:
            set_rotation = &#39;\n    config.set_rotation(Rotation.{:s})&#39;.format(
                rotation.name)
            import_rotation = &#39;from eink.generate import Rotation\n&#39;

        if os.path.dirname(client_dir) != server_dir:
            set_client_dir = &#39;    dir_ = {:s}&#39;.format(repr(client_dir))
        else:
            set_client_dir = (
                &#39;    project_dir = &#39;
                &#39;os.path.dirname(os.path.abspath(__file__))\n&#39;
                &#39;    dir_ = os.path.join(project_dir, {:s})&#39;.format(
                    repr(os.path.basename(client_dir))))
            import_os = &#39;\nimport os&#39;
            import_separator = &#39;\n&#39;

        ServerCodeGenerator._eval_template(
            server_dir, &#39;gen_client_code.py&#39;, {
                &#39;import_json&#39;: import_json,
                &#39;import_os&#39;: import_os,
                &#39;import_rotation&#39;: import_rotation,
                &#39;import_separator&#39;: import_separator,
                &#39;read_secrets&#39;: read_secrets,
                &#39;set_client_dir&#39;: set_client_dir,
                &#39;set_rotation&#39;: set_rotation,
                &#39;ssid&#39;: repr(ssid),
                &#39;url&#39;: repr(url),
                &#39;wi_fi_password&#39;: wi_fi_password_code,
            })

    @staticmethod
    def _gen_client_code(
            client_dir, url, ssid, wi_fi_password, rotation, width, height):
        &#34;&#34;&#34;Generate the client code for the skeleton.

        Arguments:
            client_dir (str): The directory in which to store the client
                code.
            url (str): The server&#39;s URL.
            ssid (str): The SSID of the Wi-Fi network that the client
                should connect to.
            wi_fi_password (str): The password of the Wi-Fi network that
                the client should connect to. If this is ``&#39;&#39;``, then
                there is no password.
            rotation (Rotation): The rotation to use when drawing to the
                Inkplate device.
            width (str): The width of the Inkplate device, as a string,
                after applying the rotation suggested by ``rotation``.
            height (str): The height of the Inkplate device, as a
                string, after applying the rotation suggested by
                ``rotation``.
        &#34;&#34;&#34;
        status_images = StatusImages.create_default(int(width), int(height))
        config = ClientConfig(WebTransport(url), status_images)
        if wi_fi_password:
            config.add_wi_fi_network(ssid, wi_fi_password)
        else:
            config.add_wi_fi_network(ssid, None)
        config.set_rotation(rotation)
        ClientCodeGenerator.gen(config, client_dir)

    @staticmethod
    def _gen_skeleton(
            server_dir, client_dir, url, ssid, wi_fi_password, rotation_str,
            width, height):
        &#34;&#34;&#34;Generate a skeleton server.

        Arguments:
            server_dir (str): The directory in which to store the
                server.
            client_dir (str): The directory in which to store the client
                code.
            url (str): The server&#39;s URL.
            ssid (str): The SSID of the Wi-Fi network that the client
                should connect to.
            wi_fi_password (str): The password of the Wi-Fi network that
                the client should connect to. If this is ``&#39;&#39;``, then
                there is no password.
            rotation_str (str): The rotation to use when drawing to the
                Inkplate device. This is the string representation of
                the value of the relevant ``Rotation``.
            width (str): The width of the Inkplate device, as a string,
                after applying the rotation suggested by
                ``rotation_str``.
            height (str): The height of the Inkplate device, as a
                string, after applying the rotation suggested by
                ``rotation_str``.
        &#34;&#34;&#34;
        server_dir = ServerCodeGenerator._normalize_filename(server_dir)
        assets_dir = os.path.join(server_dir, &#39;assets&#39;)
        client_dir = ServerCodeGenerator._normalize_filename(client_dir)
        if not os.path.exists(server_dir):
            os.mkdir(server_dir)
        if not os.path.exists(assets_dir):
            os.mkdir(assets_dir)
        if not os.path.exists(client_dir):
            os.mkdir(client_dir)

        ServerCodeGenerator._eval_template(
            server_dir, &#39;my_server.py&#39;, {
                &#39;height&#39;: height,
                &#39;width&#39;: width,
            })

        parsed_url = urlparse(url)
        if parsed_url.path:
            path = parsed_url.path
        else:
            path = &#39;/&#39;
        ServerCodeGenerator._eval_template(
            server_dir, &#39;app.py&#39;, {&#39;path&#39;: repr(path)})

        shutil.copy(
            os.path.join(Project.server_skeleton_dir(), &#39;requirements.txt&#39;),
            os.path.join(server_dir, &#39;requirements.txt&#39;))
        shutil.copy(
            os.path.join(Project.server_skeleton_dir(), &#39;GentiumPlus-R.ttf&#39;),
            os.path.join(assets_dir, &#39;GentiumPlus-R.ttf&#39;))
        shutil.copy(
            os.path.join(Project.server_skeleton_dir(), &#39;OFL.txt&#39;),
            os.path.join(assets_dir, &#39;OFL.txt&#39;))

        if wi_fi_password:
            secrets = {&#39;wiFiPassword&#39;: wi_fi_password}
            with open(os.path.join(assets_dir, &#39;secrets.json&#39;), &#39;w&#39;) as file:
                file.write(json.dumps(secrets, indent=4))
                file.write(&#39;\n&#39;)

        rotation = Rotation(int(rotation_str))
        ServerCodeGenerator._write_gen_client_code(
            server_dir, client_dir, url, ssid, wi_fi_password, rotation)
        ServerCodeGenerator._gen_client_code(
            client_dir, url, ssid, wi_fi_password, rotation, width, height)</code></pre>
</details>
<h3>Static methods</h3>
<dl>
<dt id="eink.generate.server_code_generator.ServerCodeGenerator.gen_skeleton"><code class="name flex">
<span>def <span class="ident">gen_skeleton</span></span>(<span>)</span>
</code></dt>
<dd>
<section class="desc"><p>Generate skeleton code for an e-ink server.</p>
<p>We request information about the server using standard input and
output.</p></section>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@staticmethod
def gen_skeleton():
    &#34;&#34;&#34;Generate skeleton code for an e-ink server.

    We request information about the server using standard input and
    output.
    &#34;&#34;&#34;
    ServerCodeGenerator._gen_skeleton(
        *ServerCodeGenerator._input_skeleton_params())</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="eink.generate" href="index.html">eink.generate</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="eink.generate.server_code_generator.ServerCodeGenerator" href="#eink.generate.server_code_generator.ServerCodeGenerator">ServerCodeGenerator</a></code></h4>
<ul class="">
<li><code><a title="eink.generate.server_code_generator.ServerCodeGenerator.gen_skeleton" href="#eink.generate.server_code_generator.ServerCodeGenerator.gen_skeleton">gen_skeleton</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.7.5</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>